<!--  This code works in the preview for both PNGs and 3d models -->

<html>
 <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>A Digital Diorama</title>
<meta aframe-injected="" name="mobile-web-app-capable" content="yes">
<meta aframe-injected="" name="theme-color" content="black">
<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-thumb-controls-component@1.1.0/dist/aframe-thumb-controls-component.min.js"></script>
<script src="https://rawgit.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
<script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>
</head>
<body>
<a-scene loading-screen="dotsColor: #DF5532; backgroundColor: #ffffff00">
<a-assets>
<a-asset-item id="library" src="https://ipeyhukhzevbldkqueba.supabase.co/storage/v1/object/public/files/3d/mushrooms-chjmsaj5o5w-1748451010131.glb"></a-asset-item>
<img id="carrotImage" src="https://ipeyhukhzevbldkqueba.supabase.co/storage/v1/object/public/files/images/carrots-2r0yjs8umg4-1748450995896.png" crossorigin="anonymous">
</a-assets>

<!-- Sky for better visibility -->
<a-sky color="#87CEEB"></a-sky>

<!-- Ground plane -->
<a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" color="#228B22" shadow="receive: true"></a-plane>

<!-- LITTLE FREE LIBRARY -->
<a-entity
id="libraryEntity"
gltf-model="#library"
position="0 1.5 0"
scale="2 2 2"
rotation="0 -116 0"
shadow="cast: true; receive: true"
></a-entity>

<!-- CARROT IMAGE PLANE - positioned where camera can see it -->
<a-plane
id="carrotPlane"
position="-3 2 5"
rotation="0 45 0"
width="4"
height="3"
material="src: #carrotImage; transparent: true; side: double"
shadow="receive: true"
visible="true"
></a-plane>

<!-- Fallback plane with solid color to test visibility -->
<a-plane
position="3 2 5"
rotation="0 -45 0"
width="2"
height="2"
color="red"
></a-plane>

<!-- TEXT -->
<a-text font="kelsonsans" value="Computer: WASD + mouse to move" width="50" position="21 20 -29" rotation="0 0 0" color="#0d0c0c"></a-text>
<a-text font="kelsonsans" value="Mobile: tap, hold and point." width="50" position="21 11 -23" rotation="0 0 0" color="#0d0c0c"></a-text>

<!-- Basic movement and teleportation -->
<a-entity id="cameraRig" movement-controls="constrainToNavMesh: false;" navigator="cameraRig: #cameraRig; cameraHead: #head; collisionEntities: .collision; ignoreEntities: .clickable" position="0 2 8" rotation="0 0 0">
<!-- camera -->
<a-entity id="head" camera="active: true" position="0 1.6 0" look-controls="pointerLockEnabled: true; reverseMouseDrag: false" ></a-entity>
<!-- Left Controller -->
<a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #15ACCF" teleport-controls="cameraRig: #cameraRig; teleportOrigin: #head; button: trigger; curveShootingSpeed: 18; landingMaxAngle: 60" visible="true"></a-entity>
<!-- Right Controller -->
<a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #15ACCF" laser-controls raycaster="showLine: true; far: 10; interval: 0; objects: .clickable, a-link;" line="color: #7cfc00; opacity: 0.5" visible="true"></a-entity>
</a-entity>

<!-- Lighting -->
<a-light type="ambient" color="#404040"></a-light>
<a-light type="directional" position="2 4 3" color="#ffffff" intensity="0.5" shadow="cast: true"></a-light>

</a-scene>
</body>
</html>


<!-- This code does not work in the preview for PNGs and 3d models -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Agriquest Vegetable Museum</title>
    <!-- Prevent default mobile zoom behavior -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <meta aframe-injected="" name="mobile-web-app-capable" content="yes" />
    <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-thumb-controls-component@1.1.0/dist/aframe-thumb-controls-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    
    <style>
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-family: Arial, sans-serif;
      }
      
      .loading-text {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      .loading-progress {
        width: 80%;
        max-width: 400px;
        height: 20px;
        background-color: #333;
        border-radius: 10px;
        overflow: hidden;
      }
      
      .loading-bar {
        height: 100%;
        width: 0%;
        background-color: #4CAF50;
        transition: width 0.3s ease;
      }
      
      .museum-info {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        max-width: 300px;
        z-index: 100;
        display: none;
      }
      
      .vr-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        cursor: pointer;
        z-index: 100;
      }
      
      .controls-guide {
        position: fixed;
        top: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        max-width: 300px;
        z-index: 100;
      }
    </style>

    <!-- Custom Components -->
    <script>
      // Loading manager component
      AFRAME.registerSystem('loading-manager', {
        init: function () {
          this.loadingOverlay = document.createElement('div');
          this.loadingOverlay.className = 'loading-overlay';
          
          this.loadingText = document.createElement('div');
          this.loadingText.className = 'loading-text';
          this.loadingText.textContent = 'Loading Vegetable Museum...';
          
          this.progressContainer = document.createElement('div');
          this.progressContainer.className = 'loading-progress';
          
          this.progressBar = document.createElement('div');
          this.progressBar.className = 'loading-bar';
          
          this.progressContainer.appendChild(this.progressBar);
          this.loadingOverlay.appendChild(this.loadingText);
          this.loadingOverlay.appendChild(this.progressContainer);
          
          document.body.appendChild(this.loadingOverlay);
          
          this.totalAssets = 0;
          this.loadedAssets = 0;
          
          // Count all assets to load
          const assets = document.querySelector('a-assets');
          if (assets) {
            this.totalAssets = assets.querySelectorAll('*').length;
          }
          
          this.setupEventListeners();
        },
        
        setupEventListeners: function() {
          const assets = document.querySelector('a-assets');
          if (assets) {
            assets.addEventListener('loaded', this.onAssetsLoaded.bind(this));
            
            const assetItems = assets.querySelectorAll('*');
            assetItems.forEach(item => {
              item.addEventListener('loaded', this.onAssetLoaded.bind(this));
            });
          }
          
          this.sceneEl.addEventListener('loaded', this.checkAllLoaded.bind(this));
        },
        
        onAssetLoaded: function() {
          this.loadedAssets++;
          const progress = (this.loadedAssets / this.totalAssets) * 100;
          this.progressBar.style.width = progress + '%';
        },
        
        onAssetsLoaded: function() {
          this.progressBar.style.width = '100%';
          this.checkAllLoaded();
        },
        
        checkAllLoaded: function() {
          if (this.sceneEl.hasLoaded && this.progressBar.style.width === '100%') {
            setTimeout(() => {
              this.loadingOverlay.style.opacity = '0';
              this.loadingOverlay.style.transition = 'opacity 1s ease';
              setTimeout(() => {
                this.loadingOverlay.style.display = 'none';
              }, 1000);
            }, 500);
          }
        }
      });

      // Face-camera component to keep elements facing the camera.
      AFRAME.registerComponent("face-camera", {
        schema: {
          preserveY: { type: "boolean", default: false } // Option to maintain Y-axis orientation
        },
        tick: function () {
          var camera = document.querySelector("[camera]");
          if (!camera) return;
          
          if (this.data.preserveY) {
            // Billboard behavior that only rotates around Y axis (for hotspots)
            var cameraPosition = camera.object3D.position.clone();
            var objPosition = this.el.object3D.position.clone();
            
            // Create a direction vector in the horizontal plane only
            cameraPosition.y = objPosition.y;
            this.el.object3D.lookAt(cameraPosition);
          } else {
            // Full billboard behavior (for image panels)
            this.el.object3D.lookAt(camera.object3D.position);
          }
        }
      });

      // Spot component for hotspot behavior with enhanced functionality
      AFRAME.registerComponent("spot", {
        schema: {
          linkto: { type: "string", default: "" },
          spotgroup: { type: "string", default: "" },
          label: { type: "string", default: "" },
          audio: { type: "selector", default: null },
          labelBackground: { type: "string", default: "#000000" },
          info: { type: "string", default: "" },
          vegetableModel: { type: "string", default: "" },
          revealAnimation: { type: "boolean", default: false }
        },
        init: function () {
          var data = this.data;
          var el = this.el;
          
          // Create hotspot visual
          el.setAttribute("geometry", { primitive: "circle", radius: 0.5 });
          el.setAttribute("material", {
            color: "#FFFFFF",
            opacity: 0.6,
            transparent: true,
            src: "https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/hotspot.png?v=1746470775132",
          });
          
          // Add pulse animation
          el.setAttribute("animation__pulse", {
            property: "scale",
            dir: "alternate",
            dur: 1000,
            easing: "easeInOutSine",
            loop: true,
            to: "1.1 1.1 1.1"
          });
          
          // Set up audio controls
          this.isPlaying = false;
          this.gazeTimeout = null;
          this.gazeThreshold = 1500; // 1.5 seconds gaze to activate
          
          // Create audio control buttons
          if (data.audio) {
            // Container for audio controls
            this.audioControls = document.createElement("a-entity");
            this.audioControls.setAttribute("position", "0 -0.8 0");
            
            // Play button
            this.playButton = document.createElement("a-entity");
            this.playButton.setAttribute("geometry", "primitive: circle; radius: 0.25");
            this.playButton.setAttribute("material", "color: #4CAF50; opacity: 0.9");
            this.playButton.setAttribute("position", "-0.3 0 0");
            this.playButton.setAttribute("class", "clickable");
            
            // Play icon (triangle)
            const playIcon = document.createElement("a-entity");
            playIcon.setAttribute("geometry", "primitive: triangle; vertexA: 0.15 0 0; vertexB: -0.05 0.1 0; vertexC: -0.05 -0.1 0");
            playIcon.setAttribute("material", "color: white; shader: flat");
            playIcon.setAttribute("position", "-0.05 0 0.01");
            this.playButton.appendChild(playIcon);
            
            // Pause button
            this.pauseButton = document.createElement("a-entity");
            this.pauseButton.setAttribute("geometry", "primitive: circle; radius: 0.25");
            this.pauseButton.setAttribute("material", "color: #F44336; opacity: 0.9");
            this.pauseButton.setAttribute("position", "0.3 0 0");
            this.pauseButton.setAttribute("class", "clickable");
            
            // Pause icon (two rectangles)
            const pauseBarLeft = document.createElement("a-entity");
            pauseBarLeft.setAttribute("geometry", "primitive: box; width: 0.06; height: 0.15; depth: 0.01");
            pauseBarLeft.setAttribute("material", "color: white; shader: flat");
            pauseBarLeft.setAttribute("position", "-0.04 0 0.01");
            this.pauseButton.appendChild(pauseBarLeft);
            
            const pauseBarRight = document.createElement("a-entity");
            pauseBarRight.setAttribute("geometry", "primitive: box; width: 0.06; height: 0.15; depth: 0.01");
            pauseBarRight.setAttribute("material", "color: white; shader: flat");
            pauseBarRight.setAttribute("position", "0.04 0 0.01");
            this.pauseButton.appendChild(pauseBarRight);
            
            // Add audio progress indicator
            this.progressBar = document.createElement("a-entity");
            this.progressBar.setAttribute("geometry", "primitive: plane; width: 0.8; height: 0.1");
            this.progressBar.setAttribute("material", "color: #333333; opacity: 0.8");
            this.progressBar.setAttribute("position", "0 -0.4 0");
            
            this.progressIndicator = document.createElement("a-entity");
            this.progressIndicator.setAttribute("geometry", "primitive: plane; width: 0.01; height: 0.1");
            this.progressIndicator.setAttribute("material", "color: #FFFFFF; opacity: 1");
            this.progressIndicator.setAttribute("position", "-0.4 0 0.01"); // Start at the left
            this.progressBar.appendChild(this.progressIndicator);
            
            // Add all controls to container
            this.audioControls.appendChild(this.playButton);
            this.audioControls.appendChild(this.pauseButton);
            this.audioControls.appendChild(this.progressBar);
            el.appendChild(this.audioControls);
            
            // Initially hide controls
            this.audioControls.setAttribute("visible", false);
            
            // Set up event listeners for audio buttons
            this.playButton.addEventListener("click", () => {
              this.playAudio();
            });
            
            this.pauseButton.addEventListener("click", () => {
              this.pauseAudio();
            });
            
            // Set up audio time update handler
            if (data.audio) {
              data.audio.addEventListener("timeupdate", () => {
                if (this.isPlaying && data.audio.duration) {
                  const progress = data.audio.currentTime / data.audio.duration;
                  const position = -0.4 + (progress * 0.8); // Map 0-1 to -0.4 to 0.4
                  this.progressIndicator.setAttribute("position", `${position} 0 0.01`);
                }
              });
              
              data.audio.addEventListener("ended", () => {
                this.isPlaying = false;
                // Reset progress
                this.progressIndicator.setAttribute("position", "-0.4 0 0.01");
              });
            }
            
            // Setup gaze tracking for controls
            el.addEventListener("mouseenter", () => {
              // Show controls on mouse enter
              if (data.audio) {
                this.audioControls.setAttribute("visible", true);
                
                // Set gaze timeout
                this.gazeTimeout = setTimeout(() => {
                  // Toggle audio play/pause after threshold
                  if (this.isPlaying) {
                    this.pauseAudio();
                  } else {
                    this.playAudio();
                  }
                }, this.gazeThreshold);
              }
            });
            
            el.addEventListener("mouseleave", () => {
              // Hide controls on mouse leave after delay
              setTimeout(() => {
                if (data.audio && !this.isPlaying) {
                  this.audioControls.setAttribute("visible", false);
                }
              }, 1000);
              
              // Clear gaze timeout
              if (this.gazeTimeout) {
                clearTimeout(this.gazeTimeout);
                this.gazeTimeout = null;
              }
            });
          }
          
          // Create label if provided
          if (data.label) {
            var textEntity = document.createElement("a-text");
            textEntity.setAttribute("value", data.label);
            textEntity.setAttribute("align", "center");
            textEntity.setAttribute("position", "0 0.6 0");
            textEntity.setAttribute("scale", "0.5 0.5 0.5");
            textEntity.setAttribute("color", "#FFFFFF");
            
            var bgEntity = document.createElement("a-plane");
            bgEntity.setAttribute("color", data.labelBackground);
            bgEntity.setAttribute("position", "0 0.6 -0.01");
            bgEntity.setAttribute("width", data.label.length * 0.15 + 0.2);
            bgEntity.setAttribute("height", "0.3");
            bgEntity.setAttribute("opacity", "0.8");
            
            el.appendChild(bgEntity);
            el.appendChild(textEntity);
          }
          
          // Set up click event
          el.addEventListener("click", () => {
            // Handle group visibility if specified
            if (data.spotgroup) {
              var allGroups = document.querySelectorAll('[id^="group-"]');
              allGroups.forEach(function (group) {
                group.setAttribute("visible", false);
              });
              var targetGroup = document.querySelector("#" + data.spotgroup);
              if (targetGroup) {
                targetGroup.setAttribute("visible", true);
              }
            }
            
            // Show info panel if specified
            if (data.info) {
              const infoPanel = document.querySelector('.museum-info');
              if (infoPanel) {
                infoPanel.textContent = data.info;
                infoPanel.style.display = 'block';
                
                // Hide after 10 seconds
                setTimeout(() => {
                  infoPanel.style.display = 'none';
                }, 10000);
              }
            }
            
            // Handle 3D model animation if specified
            if (data.vegetableModel) {
              const model = document.querySelector(data.vegetableModel);
              if (model && data.revealAnimation) {
                model.setAttribute("animation__reveal", {
                  property: "position",
                  to: model.getAttribute("position").x + " " + (model.getAttribute("position").y + 1) + " " + model.getAttribute("position").z,
                  dur: 1000,
                  easing: "easeOutElastic"
                });
                
                model.setAttribute("animation__spin", {
                  property: "rotation",
                  to: "0 360 0",
                  loop: 1,
                  dur: 2000,
                  easing: "easeOutQuad"
                });
              }
            }

            // Teleport if linkto is specified
            if (data.linkto && data.linkto !== "") {
              var targetPoint = document.querySelector(data.linkto);
              if (targetPoint) {
                // Add a flash effect before teleport
                document.querySelector('a-scene').setAttribute('animation__flash', {
                  property: 'background.color',
                  from: '#000',
                  to: '#fff',
                  dur: 100,
                  dir: 'alternate',
                  loop: 2
                });
                
                setTimeout(() => {
                  var cameraRig = document.querySelector("#cameraRig");
                  cameraRig.setAttribute("position", targetPoint.getAttribute("position"));
                }, 200);
              }
            }
          });
        },
        
        playAudio: function() {
          if (this.data.audio) {
            // Stop any other playing audio
            document.querySelectorAll('audio').forEach(audio => {
              if (audio !== this.data.audio) {
                audio.pause();
                audio.currentTime = 0;
                
                // Reset other hotspots' play state
                document.querySelectorAll('[spot]').forEach(spot => {
                  if (spot !== this.el && spot.components.spot) {
                    spot.components.spot.isPlaying = false;
                  }
                });
              }
            });
            
            // Play this audio
            this.data.audio.play();
            this.isPlaying = true;
            
            // Visual feedback for playing state
            this.playButton.setAttribute("material", "opacity", 0.4);
            this.pauseButton.setAttribute("material", "opacity", 0.9);
            
            // Add a visual indicator that audio is playing
            this.el.setAttribute("animation__playing", {
              property: "material.emissive",
              to: "#4CAF50",
              dur: 500
            });
            
            // Show a notification
            const notification = document.createElement('div');
            notification.textContent = 'Playing Audio';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
            notification.style.color = 'white';
            notification.style.padding = '10px 15px';
            notification.style.borderRadius = '5px';
            notification.style.fontFamily = 'Arial, sans-serif';
            notification.style.zIndex = '100';
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.style.opacity = '0';
              notification.style.transition = 'opacity 0.5s ease';
              setTimeout(() => {
                document.body.removeChild(notification);
              }, 500);
            }, 2000);
          }
        },
        
        pauseAudio: function() {
          if (this.data.audio) {
            this.data.audio.pause();
            this.isPlaying = false;
            
            // Visual feedback for paused state
            this.playButton.setAttribute("material", "opacity", 0.9);
            this.pauseButton.setAttribute("material", "opacity", 0.4);
            
            // Reset visual indicator
            this.el.setAttribute("animation__playing", {
              property: "material.emissive",
              to: "#000000",
              dur: 500
            });
            
            // Show a notification
            const notification = document.createElement('div');
            notification.textContent = 'Audio Paused';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'rgba(244, 67, 54, 0.8)';
            notification.style.color = 'white';
            notification.style.padding = '10px 15px';
            notification.style.borderRadius = '5px';
            notification.style.fontFamily = 'Arial, sans-serif';
            notification.style.zIndex = '100';
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.style.opacity = '0';
              notification.style.transition = 'opacity 0.5s ease';
              setTimeout(() => {
                document.body.removeChild(notification);
              }, 500);
            }, 2000);
          }
        }
      });

      // Enhanced mobile movement with better controls
      AFRAME.registerComponent("enhanced-mobile-controls", {
        schema: {
          speed: { type: "number", default: 2 }
        },
        init: function () {
          var self = this;
          this.numFingers = 0;
          this.verticalMovementLocked = true; // Lock vertical movement
          
          // Control mappings
          this.updateTouches = function (event) {
            event.preventDefault();
            self.numFingers = event.touches.length;
          };
          
          this.clearTouches = function (event) {
            event.preventDefault();
            self.numFingers = (event.touches && event.touches.length) || 0;
          };
          
          // Wait for canvas to be available
          this.el.sceneEl.addEventListener("renderstart", function () {
            var canvas = self.el.sceneEl.canvas;
            canvas.addEventListener("touchstart", self.updateTouches, { passive: false });
            canvas.addEventListener("touchmove", self.updateTouches, { passive: false });
            canvas.addEventListener("touchend", self.clearTouches, { passive: false });
            canvas.addEventListener("touchcancel", self.clearTouches, { passive: false });
          });
          
          // Disable other controls on mobile
          if (AFRAME.utils.device.isMobile()) {
            var leftCtrl = document.querySelector("#left-controller");
            var rightCtrl = document.querySelector("#right-controller");
            if (leftCtrl) {
              leftCtrl.removeAttribute("blink-controls");
            }
            if (rightCtrl) {
              rightCtrl.removeAttribute("blink-controls");
            }
          }
          
          // Add mobile control UI overlay
          const controlsGuide = document.createElement('div');
          controlsGuide.className = 'controls-guide';
          controlsGuide.innerHTML = 'Touch screen to move:<br>• One finger - Move forward<br>• Two fingers - Move backward<br>• Look around to change direction';
          document.body.appendChild(controlsGuide);
          
          // Hide controls after 5 seconds
          setTimeout(() => {
            controlsGuide.style.opacity = '0';
            controlsGuide.style.transition = 'opacity 1s ease';
            setTimeout(() => {
              controlsGuide.style.display = 'none';
            }, 1000);
          }, 5000);
        },
        tick: function (time, deltaTime) {
          if (this.numFingers === 0) {
            return;
          }
          
          // Calculate move distance for this tick
          var distance = this.data.speed * (deltaTime / 1000);
          
          // Adjust direction based on number of fingers:
          // One finger: move forward. Two fingers: move backward
          var moveMultiplier = this.numFingers === 1 ? -1 : 1;
          
          var cameraEl = this.el.querySelector("[camera]");
          if (cameraEl) {
            // Get the direction vector but ignore vertical component
            var direction = new THREE.Vector3();
            cameraEl.object3D.getWorldDirection(direction);
            
            // Lock vertical movement by zeroing out the y component
            // and normalizing the vector again
            if (this.verticalMovementLocked) {
              direction.y = 0;
              direction.normalize();
            }
            
            direction.multiplyScalar(distance * moveMultiplier);
            this.el.object3D.position.add(direction);
            
            // Always maintain a fixed height above ground
            this.el.object3D.position.y = 0;
          }
        },
        remove: function () {
          var canvas = this.el.sceneEl.canvas;
          canvas.removeEventListener("touchstart", this.updateTouches);
          canvas.removeEventListener("touchmove", this.updateTouches);
          canvas.removeEventListener("touchend", this.clearTouches);
          canvas.removeEventListener("touchcancel", this.clearTouches);
        }
      });
      
      // Sound effect component
      AFRAME.registerComponent('sound-effects', {
        init: function() {
          this.sounds = {
            ambient: new Howl({
              src: ['https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/ambient_nature.mp3?v=1746470754684'],
              loop: true,
              volume: 0.3,
              autoplay: false
            }),
            click: new Howl({
              src: ['https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/click.mp3?v=1746470754684'],
              volume: 0.5
            }),
            teleport: new Howl({
              src: ['https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/teleport.mp3?v=1746470754684'],
              volume: 0.7
            })
          };
          
          // Play ambient sound after a delay
          setTimeout(() => {
            this.sounds.ambient.play();
          }, 2000);
          
          // Add click sound to all clickable elements
          document.querySelectorAll('.clickable').forEach(el => {
            el.addEventListener('click', () => {
              this.sounds.click.play();
            });
          });
        }
      });
      
      // Day-night cycle component
      AFRAME.registerComponent('day-night-cycle', {
        schema: {
          cycleLength: { type: 'number', default: 120 } // seconds for a full cycle
        },
        init: function() {
          this.sky = document.querySelector('a-sky');
          this.skyDay = 'https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/day.jpg?v=1746470542948';
          this.skyNight = 'https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/night.jpg?v=1746470754684';
          this.cycleTime = 0;
          
          // Create a directional light for the sun
          this.sunLight = document.createElement('a-entity');
          this.sunLight.setAttribute('light', {
            type: 'directional',
            color: '#FFF',
            intensity: 0.8
          });
          this.sunLight.setAttribute('position', '0 10 0');
          this.el.sceneEl.appendChild(this.sunLight);
        },
        tick: function(time, deltaTime) {
          this.cycleTime = (this.cycleTime + deltaTime / 1000) % this.data.cycleLength;
          const dayProgress = this.cycleTime / this.data.cycleLength;
          
          // Change sky color and lighting based on time of day
          if (dayProgress < 0.5) {
            // Day to night transition
            const t = dayProgress * 2; // 0 to 1 during first half of cycle
            this.sky.setAttribute('material', {
              src: this.skyDay,
              opacity: 1 - t * 0.6 // Sky gets darker
            });
            
            // Sun position and intensity
            const sunAngle = Math.PI * t;
            this.sunLight.setAttribute('position', {
              x: Math.cos(sunAngle) * 10,
              y: Math.sin(sunAngle) * 10 + 1,
              z: 0
            });
            this.sunLight.setAttribute('light', {
              intensity: 0.8 - t * 0.6
            });
          } else {
            // Night to day transition
            const t = (dayProgress - 0.5) * 2; // 0 to 1 during second half
            this.sky.setAttribute('material', {
              src: this.skyNight,
              opacity: 0.4 + t * 0.6 // Sky gets brighter
            });
            
            // Sun position and intensity
            const sunAngle = Math.PI * (1 + t);
            this.sunLight.setAttribute('position', {
              x: Math.cos(sunAngle) * 10,
              y: Math.sin(sunAngle) * 10 + 1,
              z: 0
            });
            this.sunLight.setAttribute('light', {
              intensity: 0.2 + t * 0.6
            });
          }
        }
      });
    </script>
  </head>

  <body>
    <a-scene 
      loading-manager
      cursor="rayOrigin: mouse" 
      sound-effects
      day-night-cycle="cycleLength: 180">
      
      <!-- UI Overlays -->
      <div class="museum-info">Welcome to the Vegetable Museum</div>
      
      <!-- Camera Rig with Enhanced Controls -->
      <a-entity
        id="cameraRig"
        enhanced-mobile-controls="speed: 3"
        movement-controls="fly: false; constrainToNavMesh: false;"
        navigator="cameraRig: #cameraRig; cameraHead: #head; collisionEntities: .collision; ignoreEntities: .clickable"
        position="0 0 0"
        rotation="0 0 0"
      >
        <a-entity
          id="head"
          camera="active: true"
          look-controls="pointerLockEnabled: true; reverseMouseDrag: false"
          wasd-controls="fly: false"
          position="0 1.6 0"
        >
          <a-cursor
            fuse="true"
            fuse-timeout="1500"
            animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
            animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
            animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
            raycaster="objects: .clickable"
          ></a-cursor>
        </a-entity>

        <!-- Controllers with improved teleportation -->
        <a-entity
          id="left-controller"
          laser-controls="hand: left"
          raycaster="objects: .clickable, .ground"
          blink-controls="cameraRig: #cameraRig; teleportOrigin: #cameraRig; collisionEntities: .ground; landingMaxAngle: 45; buttonTopoOffset: 0.1"
          visible="true"
        ></a-entity>
        
        <a-entity
          id="right-controller"
          laser-controls="hand: right"
          raycaster="objects: .clickable, .ground"
          blink-controls="cameraRig: #cameraRig; teleportOrigin: #cameraRig; collisionEntities: .ground; landingMaxAngle: 45; buttonTopoOffset: 0.1"
          visible="true"
        ></a-entity>
      </a-entity>

      <!-- Assets with improved organization -->
      <a-assets timeout="10000">
        <!-- Images -->
        <img id="image1" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/slide1.png?v=1746475270760" />
        <img id="image2" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/carrots.png?v=1746477193116" />
        <img id="image3" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/onions.png?v=1746477197261" />
        <img id="arrowLeft" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/left-arrow.png?v=1746470754984" />
        <img id="arrowRight" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/right-arrow.png?v=1746470763334" />
        <img id="grid" src="images/border.jpg" />
        <img id="sky" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/day.jpg?v=1746470542948" />
        <img id="ground" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/grass.jpg?v=1746470564686" />
        <img id="hotspot" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/hotspot.png?v=1746470775132" />
        
        <!-- 3D Models -->
        <a-asset-item id="mushrooms" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/mushrooms.glb?v=1746470388919"></a-asset-item>
        <a-asset-item id="carrot" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/carrot.glb?v=1746473870987"></a-asset-item>
        <a-asset-item id="onion" src="https://cdn.glitch.global/2ca1c91e-68a7-44c0-9d41-96dc7cb81529/onion.glb?v=1746555782942"></a-asset-item>
        <a-asset-item id="bench" src="models/bench.glb"></a-asset-item>
        
        <!-- Audio -->
        <audio id="audio1" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/mushroomsaudio.mp3?v=1746472515312" preload="auto"></audio>
        <audio id="audiocarrots" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/audiocarrots.mp3?v=1746474555747" preload="auto"></audio>
        <audio id="audioonion" src="https://cdn.glitch.global/a39b243d-0aab-4e21-bb36-77d8260788f9/audioonion.mp3?v=1746477862843" preload="auto"></audio>
      </a-assets>

      <!-- Environment -->
      <a-entity light="type: ambient; color: #BBB; intensity: 1"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 1; castShadow: true" position="-1 1 0"></a-entity>
      
      <a-plane
        width="100"
        height="100"
        rotation="-90 0 0"
        material="src: #ground; repeat:10 10; transparent: false; opacity: 1; normalTextureRepeat: 10 10; roughness: 0.8"
        shadow="cast: false; receive: true"
        class="ground clickable"
      ></a-plane>

      <a-sky src="#sky"></a-sky>
      
      <!-- Interactive Info Display -->
      <a-entity id="info-display" position="0 0 -5">
        <!-- Main Display Panel with billboard behavior -->
        <a-entity 
          id="image-panel-container"
          face-camera
          position="0 2.6 -4"
        >
          <a-plane
            id="image-panel"
            position="0 0 0"
            width="4"
            height="2.5"
            material="src: #image1; side: double; shader: flat"
            visible="true"
            class="clickable"
          ></a-plane>
          
          <!-- Navigation Arrows with Improved Styling -->
          <a-entity 
            id="nav-left" 
            position="-2.3 0 0" 
            class="clickable"
          >
            <a-image
              src="#arrowLeft"
              position="0 0 0.01"
              scale="0.5 0.5 0.5"
              class="clickable"
              animation__hover="property: scale; to: 0.6 0.6 0.6; startEvents: mouseenter; endEvents: mouseleave; dir: alternate; dur: 300"
            ></a-image>
            <a-plane
              width="0.6"
              height="0.6"
              color="#333333"
              opacity="0.7"
              material="shader: flat"
            ></a-plane>
          </a-entity>
          
          <a-entity 
            id="nav-right" 
            position="2.3 0 0" 
            class="clickable"
          >
            <a-image
              src="#arrowRight"
              position="0 0 0.01"
              scale="0.5 0.5 0.5"
              class="clickable"
              animation__hover="property: scale; to: 0.6 0.6 0.6; startEvents: mouseenter; endEvents: mouseleave; dir: alternate; dur: 300"
            ></a-image>
            <a-plane
              width="0.6"
              height="0.6"
              color="#333333"
              opacity="0.7"
              material="shader: flat"
            ></a-plane>
          </a-entity>
          
          <!-- Information Display Text -->
          <a-entity
            id="info-text"
            position="0 -1.6 0"
            text="value: Welcome to the Agriquest Vegetable Museum! Explore the world of vegetables in this interactive 3D exhibit. Click on the hotspots to learn more about each vegetable.; width: 3; color: #FFFFFF; align: center"
            geometry="primitive: plane; width: 4; height: 0.8"
            material="color: #333333; opacity: 0.8; shader: flat"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- Create invisible floor collider to prevent falling through -->
      <a-box
        class="collision"
        position="0 -0.1 0"
        width="100"
        height="0.2"
        depth="100"
        visible="false"
        static-body
      ></a-box>
      
      <!-- Create invisible ceiling to prevent flying -->
      <a-box
        class="collision"
        position="0 4 0"
        width="100"
        height="0.2"
        depth="100"
        visible="false"
        static-body
      ></a-box>

      <!-- Mushroom Exhibit -->
      <a-entity id="mushroom-exhibit" position="-15 0 -17">
        <!-- Mushroom Model with simplified animations -->
        <a-entity
          id="mushroom-model"
          gltf-model="#mushrooms"
          position="0 1.5 0"
          scale="2 2 2"
          rotation="0 -116 0"
          shadow="cast: true; receive: true"
        ></a-entity>
        
        <!-- Exhibit Environment -->
        <a-entity
          geometry="primitive: cylinder; radius: 5; height: 0.1"
          position="0 0 0"
          material="color: #2D5F34; roughness: 0.9"
        ></a-entity>
        
        <!-- Information Hotspot -->
        <a-entity
          id="mushroom-hotspot"
          face-camera="preserveY: true"
          class="clickable"
          spot="label: Learn About Mushrooms; audio: #audio1; labelBackground: #333333; info: Mushrooms are fungi that grow in dark, moist environments. They are rich in vitamin D and various minerals. Some mushrooms are edible while others are poisonous.; vegetableModel: #mushroom-model; revealAnimation: true"
          position="3 1.5 0"
        ></a-entity>
      </a-entity>

      <!-- Carrot Exhibit -->
      <a-entity id="carrot-exhibit" position="-5 0 15">
        <!-- Carrot Model with simplified animations -->
        <a-entity
          id="carrot-model"
          gltf-model="#carrot"
          position="0 2 0"
          scale="0.2 0.2 0.2"
          rotation="63 96 110"
          shadow="cast: true; receive: true"
        ></a-entity>
        
        <!-- Exhibit Environment -->
        <a-entity
          geometry="primitive: cylinder; radius: 5; height: 0.1"
          position="0 0 0"
          material="color: #E6B570; roughness: 0.9"
        ></a-entity>
        
        <!-- Information Hotspot -->
        <a-entity
          id="carrot-hotspot"
          face-camera="preserveY: true"
          class="clickable"
          spot="label: Learn about Carrots; audio: #audiocarrots; info: Carrots are root vegetables rich in beta-carotene, which converts to vitamin A in the body. They help improve vision, boost immunity, and promote healthy skin.; vegetableModel: #carrot-model; revealAnimation: true"
          position="3 1.5 0"
        ></a-entity>
      </a-entity>

      <!-- Onion Exhibit -->
      <a-entity id="onion-exhibit" position="13.6 0 2">
        <!-- Onion Model with rotation removed -->
        <a-entity
          id="onion-model"
          gltf-model="#onion"
          position="44 3.6 25"
          scale="3 3 3"
          rotation="0 53 0"
          shadow="cast: true; receive: true"
        ></a-entity>
        
        <!-- Exhibit Environment -->
        <a-entity
          geometry="primitive: cylinder; radius: 5; height: 0.1"
          position="0 0 0"
          material="color: #B39DDB; roughness: 0.9"
        ></a-entity>
        
        <!-- Information Hotspot -->
        <a-entity
          id="onion-hotspot"
          face-camera="preserveY: true"
          class="clickable"
          spot="label: Learn about Onions; audio: #audioonion; info: Onions are bulbous vegetables with layers of flesh covered by a papery skin. They contain compounds that may reduce inflammation and lower cholesterol levels.; vegetableModel: #onion-model; revealAnimation: true"
          position="3 1.5 0"
        ></a-entity>
      </a-entity>

      <script>
        // Document ready handler
        document.addEventListener("DOMContentLoaded", () => {
          // Image slideshow functionality
          const images = ["#image1", "#image2", "#image3"];
          let currentIndex = 0;
          const imagePanel = document.querySelector("#image-panel");
          
          function updatePanelImage() {
            imagePanel.setAttribute("material", "src", images[currentIndex]);
            
            // Update info text based on current image
            const infoText = document.querySelector("#info-text");
            switch(currentIndex) {
              case 0:
                infoText.setAttribute("text", "value", "Welcome to the Agriquest Vegetable Museum! Explore the world of vegetables in this interactive 3D exhibit. Click on the hotspots to learn more about each vegetable.");
                break;
              case 1:
                infoText.setAttribute("text", "value", "Carrots are rich in beta-carotene which is good for eye health. They can be enjoyed raw or cooked in a variety of dishes.");
                break;
              case 2:
                infoText.setAttribute("text", "value", "Onions add flavor to countless dishes worldwide. They contain compounds that may help reduce inflammation and promote heart health.");
                break;
            }
          }
          
          document.querySelector("#nav-left").addEventListener("click", () => {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            updatePanelImage();
            // Play click sound if available
            const soundEffects = document.querySelector('[sound-effects]');
            if (soundEffects && soundEffects.components['sound-effects'].sounds.click) {
              soundEffects.components['sound-effects'].sounds.click.play();
            }
          });
          
          document.querySelector("#nav-right").addEventListener("click", () => {
            currentIndex = (currentIndex + 1) % images.length;
            updatePanelImage();
            // Play click sound if available
            const soundEffects = document.querySelector('[sound-effects]');
            if (soundEffects && soundEffects.components['sound-effects'].sounds.click) {
              soundEffects.components['sound-effects'].sounds.click.play();
            }
          });
          
          // Update hotspots to use the preserveY option
          document.querySelectorAll('[face-camera]').forEach(el => {
            // Check if this is a hotspot element (not the image panel)
            if (el.hasAttribute('spot')) {
              el.setAttribute('face-camera', 'preserveY', true);
            }
          });
          
          // VR Mode toggle
          const vrToggle = document.createElement('div');
          vrToggle.className = 'vr-toggle';
          vrToggle.textContent = 'Enter VR';
          document.body.appendChild(vrToggle);
          
          vrToggle.addEventListener('click', () => {
            const scene = document.querySelector('a-scene');
            if (scene.is('vr-mode')) {
              scene.exitVR();
              vrToggle.textContent = 'Enter VR';
            } else {
              scene.enterVR();
              vrToggle.textContent = 'Exit VR';
            }
          });
          
          // Detect device capabilities
          setTimeout(() => {
            if (AFRAME.utils.device.isMobile()) {
              document.querySelector('.controls-guide').innerHTML = 'Touch screen to move:<br>• Top half - Move forward<br>• Bottom half - Move backward<br>• Left side - Turn left<br>• Right side - Turn right';
            } else {
              document.querySelector('.controls-guide').innerHTML = 'Desktop Controls:<br>• WASD/Arrow Keys - Move<br>• Mouse - Look around<br>• Click - Interact with hotspots';
            }
          }, 1000);
        });
      </script>
    </a-scene>
  </body>
</html>