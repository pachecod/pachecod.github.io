<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DayAtTheFarmWithCaptions_Audio - VR Hotspot Experience</title>
    <meta name="description" content="Interactive VR Hotspot Experience" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
      a-text { 
        font-family: Arial; 
        font-weight: bold; 
      }
    </style>

    <script>
      // Function to update caption content based on current scene
      function updateCaptionForScene(sceneId) {
        fetch('./config.json')
          .then(response => response.json())
          .then(config => {
            if (config.scenes && config.scenes[sceneId]) {
              const scene = config.scenes[sceneId];
              
              // Look for text-audio hotspots first, then text hotspots, then use scene name
              let textAudioHotspots = scene.hotspots.filter(h => h.type === 'text-audio');
              let textHotspots = scene.hotspots.filter(h => h.type === 'text');
              
              let hotspot = null;
              let hotspotType = '';
              
              if (textAudioHotspots.length > 0) {
                // Use the first text-audio hotspot for the caption
                hotspot = textAudioHotspots[0];
                hotspotType = 'text-audio';
              } else if (textHotspots.length > 0) {
                // Use the first text hotspot for the caption
                hotspot = textHotspots[0];
                hotspotType = 'text';
              } else {
                // No text hotspots, use scene name
              }
              
              if (hotspot) {
                // Update caption label
                const captionLabel = document.getElementById('caption-label');
                if (captionLabel) {
                  captionLabel.setAttribute('value', hotspot.label);
                } else {
                  console.error('❌ Caption label element not found');
                }
                
                // Update caption text
                const captionText = document.getElementById('caption-text');
                if (captionText) {
                  captionText.setAttribute('value', hotspot.text);
                } else {
                  console.error('❌ Caption text element not found');
                }
                
                // Update audio source for the play button (only for text-audio hotspots)
                if (hotspotType === 'text-audio' && hotspot.audio) {
                  const captionAudio = document.getElementById('caption-audio');
                  if (captionAudio) {
                    // Set the audio source on the a-sound element
                    captionAudio.setAttribute('src', hotspot.audio);
                  } else {
                    console.error('❌ Caption audio element not found');
                  }
                  
                  // Show audio button and text, and reset to play state
                  const audioBtn = document.getElementById('caption-audio-btn');
                  const audioText = document.querySelector('#caption-container a-text[value="Play Audio"]');
                  if (audioBtn) {
                    audioBtn.setAttribute('visible', true);
                    audioBtn.setAttribute('src', '#play'); // Reset to play button
                  }
                  if (audioText) audioText.setAttribute('visible', true);
                  
                  // Reset the audio playing state for this new scene
                  if (window.captionAudioState) {
                    window.captionAudioState.isPlaying = false;
                  }
                  
                } else if (hotspotType === 'text') {
                  // For text-only hotspots, clear the audio source
                  const captionAudio = document.getElementById('caption-audio');
                  if (captionAudio) {
                    captionAudio.setAttribute('src', '');
                  }
                  
                  // Hide audio button and text
                  const audioBtn = document.getElementById('caption-audio-btn');
                  const audioText = document.querySelector('#caption-container a-text[value="Play Audio"]');
                  if (audioBtn) audioBtn.setAttribute('visible', false);
                  if (audioText) audioText.setAttribute('visible', false);
                }
              } else {
                // No hotspots, use scene name and description
                const captionLabel = document.getElementById('caption-label');
                if (captionLabel) {
                  captionLabel.setAttribute('value', scene.name);
                }
                
                const captionText = document.getElementById('caption-text');
                if (captionText) {
                  captionText.setAttribute('value', 'Explore this area to discover more about the farm.');
                }
                
                // Clear audio source and hide audio button
                const captionAudio = document.getElementById('caption-audio');
                if (captionAudio) {
                  captionAudio.setAttribute('src', '');
                }
                
                // Hide audio button and text
                const audioBtn = document.getElementById('caption-audio-btn');
                const audioText = document.querySelector('#caption-container a-text[value="Play Audio"]');
                if (audioBtn) audioBtn.setAttribute('visible', false);
                if (audioText) audioText.setAttribute('visible', false);
              }
            } else {
              console.error('❌ Scene not found in config:', sceneId);
            }
          })
          .catch(error => {
            console.error('❌ Error loading config:', error);
          });
      }
      
      // Listen for scene changes by monitoring the hotspot container
      document.addEventListener('DOMContentLoaded', function() {
        
        // Create a mutation observer to detect when hotspots are created
        const hotspotContainer = document.getElementById('hotspot-container');
        if (hotspotContainer) {
          
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                
                // Get the current scene from the config
                fetch('./config.json')
                  .then(response => response.json())
                  .then(config => {
                    // Find which scene is currently active by checking which scene's image is loaded
                    const skybox = document.getElementById('skybox');
                    if (skybox) {
                      const skyboxSrc = skybox.getAttribute('src');
                      
                      // Get the actual image source from the assets
                      let actualImageSrc = '';
                      if (skyboxSrc.startsWith('#')) {
                        // It's a reference to an asset, get the actual image
                        const panoramaId = skyboxSrc.substring(1);
                        const panoramaAsset = document.getElementById(panoramaId);
                        if (panoramaAsset) {
                          actualImageSrc = panoramaAsset.getAttribute('src');
                        }
                      } else {
                        actualImageSrc = skyboxSrc;
                      }
                      
                      if (actualImageSrc) {
                        // Find the scene that matches this image
                        for (const [sceneId, scene] of Object.entries(config.scenes)) {
                          // Extract filename from both URLs for comparison
                          const skyboxFilename = actualImageSrc.split('/').pop().split('?')[0];
                          const sceneFilename = scene.image.split('/').pop();
                          
                          if (skyboxFilename === sceneFilename) {
                            updateCaptionForScene(sceneId);
                            break;
                          }
                        }
                      } else {
                        console.error('❌ Could not determine actual image source');
                      }
                    } else {
                      console.error('❌ Skybox element not found');
                    }
                  })
                  .catch(error => {
                    console.error('❌ Error determining current scene:', error);
                  });
              }
            });
          });
          
          observer.observe(hotspotContainer, { childList: true });
        } else {
          console.error('❌ Hotspot container not found');
        }
        
        // Initial caption update for the first scene
        updateCaptionForScene('room1');
        
        // Add audio functionality to the play button using existing logic from script.js
        const audioBtn = document.getElementById('caption-audio-btn');
        const captionAudio = document.getElementById('caption-audio');
        
        if (audioBtn && captionAudio) {
          // Create global state for audio button
          window.captionAudioState = { isPlaying: false };
          
          audioBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (captionAudio.components && captionAudio.components.sound) {
              if (window.captionAudioState.isPlaying) {
                captionAudio.components.sound.stopSound();
                audioBtn.setAttribute('src', '#play');
              } else {
                captionAudio.components.sound.playSound();
                audioBtn.setAttribute('src', '#pause');
              }
              window.captionAudioState.isPlaying = !window.captionAudioState.isPlaying;
            }
          });
        } else {
          console.error('❌ Audio elements not found');
        }
        
        // Add info button functionality to open/close caption box
        const infoButton = document.getElementById('info-button');
        const captionContainer = document.getElementById('caption-container');
        const closeButton = document.getElementById('close-button');
        
        if (infoButton && captionContainer && closeButton) {
          // Info button click - open caption box and hide info button
          infoButton.addEventListener('click', function() {
            captionContainer.setAttribute('visible', true);
            // Hide the entire info button entity completely
            infoButton.setAttribute('visible', false);
            infoButton.style.display = 'none';
          });
          
          // Close button click - close caption box and show info button again
          closeButton.addEventListener('click', function() {
            captionContainer.setAttribute('visible', false);
            // Show the entire info button entity again
            infoButton.setAttribute('visible', true);
            infoButton.style.display = 'block';
          });
          
        } else {
          console.error('❌ Info button elements not found');
        }
        
          // Function to remove old caption elements
          function removeOldCaptionElements() {
            // Remove green "click for info" elements - more specific targeting
            const allEntities = document.querySelectorAll('a-entity');
            let removedCount = 0;
            
            allEntities.forEach(el => {
              // Check for green info elements
              const greenPlane = el.querySelector('a-plane[material*="color: #00FF00"]');
              const infoText = el.querySelector('a-text[value*="click for info"]');
              
              if (greenPlane || infoText) {
                el.remove();
                removedCount++;
              }
              
              // Check for dark gray label elements
              const darkPlane = el.querySelector('a-plane[material*="color: #333333"]');
              if (darkPlane && el.querySelector('a-text')) {
                el.remove();
                removedCount++;
              }
              
              // Check for old audio buttons
              const oldAudioBtn = el.querySelector('a-image[src*="play"], a-image[src*="pause"]');
              if (oldAudioBtn && el.getAttribute('position') && el.getAttribute('position').includes('-1 0.02')) {
                el.remove();
                removedCount++;
              }
            });
          }
        
        // Run removal function immediately and then very frequently
        removeOldCaptionElements();
        setInterval(removeOldCaptionElements, 100); // Check every 100ms instead of 1000ms
        
        // Also run when hotspots change
        if (hotspotContainer) {
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Remove old elements after hotspots are added
                setTimeout(removeOldCaptionElements, 50); // Faster timeout
                setTimeout(removeOldCaptionElements, 200); // Second check
                setTimeout(removeOldCaptionElements, 500); // Third check
              }
            });
          });
          
          observer.observe(hotspotContainer, { childList: true });
        }
      });
    </script>
  </head>
  
  <body>
    <div id="project-info">
      <h1>DayAtTheFarmWithCaptions_Audio</h1>
      <p>Interactive VR Experience • Click on hotspots to explore</p>
    </div>

    <a-scene background="color: #ECECEC" id="main-scene">
      <a-entity
        laser-controls="hand: right"
        raycaster="objects: .clickable, .audio-control"
      ></a-entity>
      <a-entity
        laser-controls="hand: left"
        raycaster="objects: .clickable, .audio-control"
      ></a-entity>

      <a-assets>
        <img id="main-panorama" src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/newtest/images/room1_1754922166488.jpg" />
        <img id="hotspot" src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/newtest/images/up-arrow_1754922188081.png" />
        <audio id="default-audio" src="./audio/music.mp3"></audio>
        <img id="close" src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/newtest/images/close_1754922163932.png" />
        <img id="play" src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/newtest/images/play_1754922165740.png" />
        <img id="pause" src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/newtest/images/pause_1754922165021.png" />
      </a-assets>

      <a-entity id="hotspot-container"></a-entity>
      <a-sky id="skybox" src="#main-panorama"></a-sky>

      <!-- Info Button (ℹ️) to open/close caption -->
      <a-entity id="info-button" position="0 2 -3">
        <a-plane 
          class="clickable info-button"
          color="#fff"
          width="0.6" 
          height="0.6" 
          position="0 0 0"
          opacity="0.1"
          radius="0.3">
        </a-plane>
        <a-image
          id="info-icon"
          src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/Dan%20Pacheco/images/info_1754932920936.png"
          width="0.6"
          height="0.6"
          position="0 0 0.01">
        </a-image>
      </a-entity>

      <!-- Caption Overlay for Scene Information (initially hidden) -->
      <a-entity id="caption-container" class="caption-container" position="0 2 -3" visible="false">
        <a-plane 
          class="caption-overlay" 
          width="4.5" 
          height="1.8" 
          position="0 0 0"
          material="color: #fff; opacity: 0.95">
        </a-plane>
        
        <!-- Close Button (X) in upper right corner -->
        <a-entity position="2.1 0.8 0.01">
          <a-image
            id="close-button"
            class="clickable close-button"
            src="https://hkfsgnludtapbbtsacwd.supabase.co/storage/v1/object/public/files/Dan%20Pacheco/images/iconmonstr-x-mark-circle-lined-240_1754932309935.png"
            width="0.4"
            height="0.4"
            position="0 0 0.01">
          </a-image>
        </a-entity>
        
        <!-- Caption Label/Title -->
        <a-text 
          id="caption-label"
          class="caption-label"
          value="Welcome to the Salt City Harvest Farm" 
          align="center" 
          width="4" 
          position="0 0.6 0.01"
          color="#000">
        </a-text>
        
        <!-- Caption Text Content -->
        <a-text 
          id="caption-text"
          class="caption-text-content"
          value="Salt City Harvest Farm grows food, culture, and community alongside the New American Community through the cross-cultural exchange of food traditions with access to farmland, education, and economic opportunities." 
          align="center" 
          width="4" 
          position="0 0.1 0.01"
          color="#000"
          wrap-count="50">
        </a-text>
        
        <!-- Audio Play Button -->
        <a-entity position="0 -0.6 0.01">
          <a-sound id="caption-audio" src="" autoplay="false" loop="true"></a-sound>
          <a-image
            id="caption-audio-btn"
            class="clickable audio-control"
            src="#play"
            width="0.5"
            height="0.5"
            position="0 0 0">
          </a-image>
          <a-text
            value="Play Audio"
            align="center"
            color="#000"
            width="2"
            position="0.7 0 0.01">
          </a-text>
        </a-entity>
      </a-entity>

      <a-entity id="cam" camera position="0 1.6 0" look-controls>
        <!-- Mouse-based cursor for non-VR mode -->
        <a-entity 
          cursor="rayOrigin: mouse; fuse: false"
          raycaster="objects: .clickable, .audio-control"
          id="mouse-cursor"
          visible="true">
        </a-entity>
        
        <!-- Gaze-based cursor for VR mode -->
        <a-entity
          cursor="fuse: true; fuseTimeout: 1500"
          raycaster="objects: .clickable, .audio-control"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.01"
          material="color: white; shader: flat; opacity: 0.8"
          id="gaze-cursor"
          visible="true"
          animation__mouseenter="property: geometry.radiusOuter; to: 0.015; startEvents: mouseenter; dur: 1500; easing: easeInQuad"
          animation__mouseleave="property: geometry.radiusOuter; to: 0.01; startEvents: mouseleave; dur: 300; easing: easeOutQuad"
          animation__click="property: scale; to: 1.2 1.2 1.2; startEvents: click; dur: 150; easing: easeInOutQuad"
          animation__fusing="property: scale; to: 1.2 1.2 1.2; startEvents: fusing; dur: 1500; easing: easeInQuad"
          animation__fusecomplete="property: scale; to: 1 1 1; startEvents: click; dur: 150; easing: easeOutQuad">
        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>