<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.S. Troop Deployment Globe</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
        }
        #globe-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        svg {
            cursor: grab;
        }
        svg:active {
            cursor: grabbing;
        }
        .country {
            stroke: #fff;
            stroke-width: 0.5px;
            transition: stroke-width 0.2s;
        }
        .country:hover {
            stroke: #333;
            stroke-width: 1.5px;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 14px;
            border-radius: 5px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .tooltip.visible {
            opacity: 1;
        }
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            max-width: 250px;
            z-index: 100;
        }
        .info-panel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .info-panel p {
            margin: 5px 0;
            font-size: 12px;
            color: #666;
        }
        .city-label {
            font-size: 11px;
            font-weight: 900;
            fill: #000;
            stroke: #fff;
            stroke-width: 3px;
            paint-order: stroke;
            pointer-events: none;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }
        .checkbox-container input {
            cursor: pointer;
        }
        .checkbox-container label {
            cursor: pointer;
            font-size: 11px;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-size: 11px;
            z-index: 100;
            min-width: 140px;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .legend-toggle {
            font-size: 16px;
            cursor: pointer;
        }
        .legend-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
            max-height: 300px;
        }
        .legend-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        .legend-color {
            width: 20px;
            height: 14px;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .zoom-controls {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
        }
        
        .zoom-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .info-panel, .legend {
                font-size: 10px;
                padding: 10px;
            }
            .info-panel {
                max-width: 180px;
            }
            .info-panel h3 {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="globe-container"></div>
    
    <div class="tooltip"></div>
    
    <div class="info-panel">
        <h3>U.S. Troop Deployments</h3>
        <p><strong>Drag to rotate</strong></p>
        <p id="hover-info">Hover over a country</p>
        <div class="checkbox-container">
            <input type="checkbox" id="show-cities" checked>
            <label for="show-cities">Show cities</label>
        </div>
    </div>
    
    <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in" title="Zoom In">üîç+</button>
        <button class="zoom-btn" id="zoom-out" title="Zoom Out">üîç‚àí</button>
    </div>
    
    <div class="legend">
        <div class="legend-title" id="legend-toggle">
            <span>Troops Deployed</span>
            <span class="legend-toggle">‚àí</span>
        </div>
        <div class="legend-content" id="legend-content">
            <div class="legend-item">
                <div class="legend-color" style="background: #e8e8e8"></div>
                <span>0</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c0c0c0"></div>
                <span>1-100</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #cfe2f3"></div>
                <span>100-500</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9fc5e8"></div>
                <span>500-1,000</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #6fa8dc"></div>
                <span>1,000-5,000</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3d85c6"></div>
                <span>5,000-10,000</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #0b5394"></div>
                <span>10,000-20,000</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e69138"></div>
                <span>20,000-50,000</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #cc0000"></div>
                <span>50,000+</span>
            </div>
        </div>
    </div>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        // Color scale function
        function getColor(troops) {
            return troops > 50000 ? '#cc0000' :
                   troops > 20000 ? '#e69138' :
                   troops > 10000 ? '#0b5394' :
                   troops > 5000  ? '#3d85c6' :
                   troops > 1000  ? '#6fa8dc' :
                   troops > 500   ? '#9fc5e8' :
                   troops > 100   ? '#cfe2f3' :
                   troops > 0     ? '#c0c0c0' :
                                    '#e8e8e8';
        }
        
        // Country name mapping
        const countryNameMap = {
            'United States of America': 'United States',
            'Republic of Korea': 'South Korea',
            'Democratic Republic of the Congo': 'Congo (Kinshasa)',
            'Republic of the Congo': 'Congo (Brazzaville)',
            'Czech Republic': 'Czechia',
            'The Bahamas': 'Bahamas',
            'Ivory Coast': "Cote d'Ivoire"
        };
        
        // Set up dimensions
        const width = window.innerWidth;
        const height = window.innerHeight;
        const radius = Math.min(width, height) / 2.2;
        
        // Create SVG
        const svg = d3.select("#globe-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        
        // Add stars to background
        const numStars = 200;
        for (let i = 0; i < numStars; i++) {
            svg.append("circle")
                .attr("cx", Math.random() * width)
                .attr("cy", Math.random() * height)
                .attr("r", Math.random() * 1.5 + 0.3)
                .attr("fill", "#ffffff")
                .attr("opacity", Math.random() * 0.7 + 0.3);
        }
        
        const g = svg.append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);
        
        // Create projection
        const projection = d3.geoOrthographic()
            .scale(radius)
            .translate([0, 0])
            .rotate([-10, -50, 0])
            .clipAngle(90);
        
        const path = d3.geoPath().projection(projection);
        
        // Add water texture pattern
        const defs = svg.append("defs");
        
        // Create subtle wave pattern
        const waterPattern = defs.append("pattern")
            .attr("id", "water-texture")
            .attr("patternUnits", "userSpaceOnUse")
            .attr("width", 30)
            .attr("height", 30);
        
        // Base water color
        waterPattern.append("rect")
            .attr("width", 30)
            .attr("height", 30)
            .attr("fill", "#5ba3d0");
        
        // Add subtle curved wave lines
        for (let i = 0; i < 6; i++) {
            waterPattern.append("path")
                .attr("d", `M -5 ${5 + i * 5} Q 2.5 ${3 + i * 5}, 7.5 ${5 + i * 5} T 22.5 ${5 + i * 5} T 37.5 ${5 + i * 5}`)
                .attr("stroke", "#4a8ab8")
                .attr("stroke-width", 1)
                .attr("fill", "none")
                .attr("opacity", 0.38);
        }
        
        // Add lighter accent waves
        for (let i = 0; i < 3; i++) {
            waterPattern.append("path")
                .attr("d", `M -5 ${7.5 + i * 10} Q 2.5 ${6 + i * 10}, 7.5 ${7.5 + i * 10} T 22.5 ${7.5 + i * 10} T 37.5 ${7.5 + i * 10}`)
                .attr("stroke", "#6bb5e0")
                .attr("stroke-width", 0.8)
                .attr("fill", "none")
                .attr("opacity", 0.25);
        }
        
        // Add ocean
        const globe = g.append("circle")
            .attr("r", radius)
            .attr("fill", "url(#water-texture)")
            .attr("stroke", "#3d7ba8")
            .attr("stroke-width", 2);
        
        // Create latitude lines
        const latitudes = [
            { lat: 0, color: "#ff6b6b", dash: "5,5", name: "equator", label: "Equator" },           
            { lat: 23.5, color: "#ffa500", dash: "3,3", name: "tropic-cancer", label: "Tropic of Cancer" },  
            { lat: -23.5, color: "#ffa500", dash: "3,3", name: "tropic-capricorn", label: "Tropic of Capricorn" }, 
            { lat: 66.5, color: "#87ceeb", dash: "3,3", name: "arctic", label: "Arctic Circle" },         
            { lat: -66.5, color: "#87ceeb", dash: "3,3", name: "antarctic", label: "Antarctic Circle" }      
        ];
        
        // Major cities
        const cities = [
            { name: "Tokyo", coords: [139.6917, 35.6895] },
            { name: "New York", coords: [-74.0060, 40.7128] },
            { name: "London", coords: [-0.1276, 51.5074] },
            { name: "Paris", coords: [2.3522, 48.8566] },
            { name: "Beijing", coords: [116.4074, 39.9042] },
            { name: "Moscow", coords: [37.6173, 55.7558] },
            { name: "Sydney", coords: [151.2093, -33.8688] },
            { name: "Cairo", coords: [31.2357, 30.0444] },
            { name: "Mumbai", coords: [72.8777, 19.0760] },
            { name: "S√£o Paulo", coords: [-46.6333, -23.5505] },
            { name: "Los Angeles", coords: [-118.2437, 34.0522] },
            { name: "Mexico City", coords: [-99.1332, 19.4326] },
            { name: "Seoul", coords: [126.9780, 37.5665] },
            { name: "Berlin", coords: [13.4050, 52.5200] },
            { name: "Singapore", coords: [103.8198, 1.3521] },
            { name: "Buenos Aires", coords: [-58.3816, -34.6037] },
            { name: "Cape Town", coords: [18.4241, -33.9249] },
            { name: "Bangkok", coords: [100.5018, 13.7563] },
            { name: "Dubai", coords: [55.2708, 25.2048] },
            { name: "Hong Kong", coords: [114.1694, 22.3193] }
        ];
        
        // Tooltip
        const tooltip = d3.select(".tooltip");
        const hoverInfo = d3.select("#hover-info");
        
        // Load data
        let troopsData = {};
        
        fetch('troops.csv')
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Create lookup object
                        results.data.forEach(row => {
                            const country = row.Country;
                            const troops = row['Troops Deployed'] || 0;
                            troopsData[country] = troops;
                        });
                        
                        // Load GeoJSON
                        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
                            .then(response => response.json())
                            .then(world => {
                                // Add countries
                                const countries = g.selectAll(".country")
                                    .data(world.features)
                                    .enter().append("path")
                                    .attr("class", "country")
                                    .attr("d", path)
                                    .attr("fill", d => {
                                        let countryName = d.properties.ADMIN || d.properties.name;
                                        if (countryNameMap[countryName]) {
                                            countryName = countryNameMap[countryName];
                                        }
                                        const troops = troopsData[countryName] || 0;
                                        return getColor(troops);
                                    })
                                    .on("mouseover", function(event, d) {
                                        let countryName = d.properties.ADMIN || d.properties.name;
                                        let displayName = countryName;
                                        if (countryNameMap[countryName]) {
                                            countryName = countryNameMap[countryName];
                                        }
                                        const troops = troopsData[countryName] || 0;
                                        
                                        tooltip
                                            .html(`<strong>${displayName}</strong><br>${troops.toLocaleString()} troops`)
                                            .style("left", (event.pageX + 15) + "px")
                                            .style("top", (event.pageY - 15) + "px")
                                            .classed("visible", true);
                                        
                                        hoverInfo.html(`<strong>${displayName}</strong><br>${troops.toLocaleString()} troops deployed`);
                                    })
                                    .on("mouseout", function() {
                                        tooltip.classed("visible", false);
                                        hoverInfo.html("Hover over a country");
                                    })
                                    .on("mousemove", function(event) {
                                        tooltip
                                            .style("left", (event.pageX + 15) + "px")
                                            .style("top", (event.pageY - 15) + "px");
                                    });
                                
                                // Add latitude lines
                                const latitudePaths = latitudes.map(l => {
                                    const line = {
                                        type: "LineString",
                                        coordinates: d3.range(-180, 181, 1).map(lon => [lon, l.lat])
                                    };
                                    
                                    // Create invisible thick line for easier hovering
                                    const hoverPath = g.append("path")
                                        .datum(line)
                                        .attr("class", `latitude-hover ${l.name}`)
                                        .attr("d", path)
                                        .attr("fill", "none")
                                        .attr("stroke", "transparent")
                                        .attr("stroke-width", 10)
                                        .style("cursor", "pointer");
                                    
                                    // Create visible line
                                    const visiblePath = g.append("path")
                                        .datum(line)
                                        .attr("class", `latitude-line ${l.name}`)
                                        .attr("d", path)
                                        .attr("fill", "none")
                                        .attr("stroke", l.color)
                                        .attr("stroke-width", l.lat === 0 ? 2 : 1.5)
                                        .attr("stroke-dasharray", l.dash)
                                        .attr("opacity", 0.6)
                                        .style("pointer-events", "none");
                                    
                                    hoverPath
                                        .on("mouseover", function(event) {
                                            visiblePath.attr("opacity", 0.9).attr("stroke-width", l.lat === 0 ? 3 : 2.5);
                                            tooltip
                                                .html(`<strong>${l.label}</strong>`)
                                                .style("left", (event.pageX + 15) + "px")
                                                .style("top", (event.pageY - 15) + "px")
                                                .classed("visible", true);
                                        })
                                        .on("mouseout", function() {
                                            visiblePath.attr("opacity", 0.6).attr("stroke-width", l.lat === 0 ? 2 : 1.5);
                                            tooltip.classed("visible", false);
                                        })
                                        .on("mousemove", function(event) {
                                            tooltip
                                                .style("left", (event.pageX + 15) + "px")
                                                .style("top", (event.pageY - 15) + "px");
                                        });
                                    
                                    return { hover: hoverPath, visible: visiblePath };
                                });
                                
                                // Add city dots - store city data with each dot
                                const cityDots = cities.map(city => {
                                    const dot = g.append("circle")
                                        .attr("class", "city-dot")
                                        .attr("r", 8)
                                        .attr("fill", "#000")
                                        .attr("stroke", "#fff")
                                        .attr("stroke-width", 1.5)
                                        .style("cursor", "pointer")
                                        .on("mouseover", function(event) {
                                            d3.select(this).attr("r", 10).attr("stroke-width", 2);
                                            tooltip
                                                .html(`<strong>${city.name}</strong>`)
                                                .style("left", (event.pageX + 15) + "px")
                                                .style("top", (event.pageY - 15) + "px")
                                                .classed("visible", true);
                                        })
                                        .on("mouseout", function() {
                                            d3.select(this).attr("r", 8).attr("stroke-width", 1.5);
                                            tooltip.classed("visible", false);
                                        })
                                        .on("mousemove", function(event) {
                                            tooltip
                                                .style("left", (event.pageX + 15) + "px")
                                                .style("top", (event.pageY - 15) + "px");
                                        });
                                    
                                    // Add city label
                                    const label = g.append("text")
                                        .attr("class", "city-label")
                                        .text(city.name);
                                    
                                    return { dot: dot, label: label, coords: city.coords };
                                });
                                
                                // Update city positions - FIXED VERSION
                                function updateCityPositions() {
                                    const showCities = document.getElementById('show-cities')?.checked ?? true;
                                    
                                    cityDots.forEach(item => {
                                        const projected = projection(item.coords);
                                        if (projected) {
                                            const [x, y] = projected;
                                            
                                            // Get the center point of the visible hemisphere
                                            const centerPoint = projection.invert([0, 0]);
                                            
                                            // Calculate angular distance from center
                                            const angle = d3.geoDistance(item.coords, centerPoint);
                                            
                                            // Check if on visible hemisphere (< 90 degrees = œÄ/2 radians)
                                            const isVisible = angle < Math.PI / 2;
                                            
                                            // Show both dot and label only if cities are enabled AND on visible side
                                            const shouldShow = isVisible && showCities;
                                            
                                            item.dot
                                                .attr("cx", x)
                                                .attr("cy", y)
                                                .style("display", shouldShow ? "block" : "none");
                                            
                                            item.label
                                                .attr("x", x + 12)
                                                .attr("y", y + 4)
                                                .style("display", shouldShow ? "block" : "none");
                                        }
                                    });
                                }
                                
                                // Initial positioning
                                updateCityPositions();
                                
                                // Dragging with momentum
                                let lastRotate;
                                let isDragging = false;
                                let needsUpdate = false;
                                let velocity = [0, 0];
                                let lastDragTime = 0;
                                let momentumAnimation = null;
                                const maxVelocity = 3;
                                
                                function clampVelocity(vel) {
                                    const speed = Math.sqrt(vel[0] * vel[0] + vel[1] * vel[1]);
                                    if (speed > maxVelocity) {
                                        const scale = maxVelocity / speed;
                                        return [vel[0] * scale, vel[1] * scale];
                                    }
                                    return vel;
                                }
                                
                                function dragstarted(event) {
                                    lastRotate = projection.rotate();
                                    isDragging = true;
                                    velocity = [0, 0];
                                    lastDragTime = Date.now();
                                    
                                    if (momentumAnimation) {
                                        cancelAnimationFrame(momentumAnimation);
                                        momentumAnimation = null;
                                    }
                                }
                                
                                function dragged(event) {
                                    const rotate = lastRotate;
                                    const k = 75 / projection.scale();
                                    const dx = event.dx * k;
                                    const dy = event.dy * k;
                                    
                                    projection.rotate([rotate[0] + dx, rotate[1] - dy]);
                                    lastRotate = projection.rotate();
                                    
                                    const now = Date.now();
                                    const dt = now - lastDragTime;
                                    if (dt > 0) {
                                        velocity = clampVelocity([dx / dt * 16, dy / dt * 16]);
                                    }
                                    lastDragTime = now;
                                    
                                    if (!needsUpdate) {
                                        needsUpdate = true;
                                        requestAnimationFrame(updatePaths);
                                    }
                                }
                                
                                function dragended(event) {
                                    isDragging = false;
                                    
                                    if (Math.abs(velocity[0]) > 0.1 || Math.abs(velocity[1]) > 0.1) {
                                        startMomentum();
                                    }
                                }
                                
                                function startMomentum() {
                                    const friction = 0.92;
                                    const minVelocity = 0.05;
                                    
                                    function animate() {
                                        velocity[0] *= friction;
                                        velocity[1] *= friction;
                                        
                                        if (Math.abs(velocity[0]) < minVelocity && Math.abs(velocity[1]) < minVelocity) {
                                            velocity = [0, 0];
                                            momentumAnimation = null;
                                            return;
                                        }
                                        
                                        const rotate = projection.rotate();
                                        projection.rotate([rotate[0] + velocity[0], rotate[1] - velocity[1]]);
                                        countries.attr("d", path);
                                        latitudePaths.forEach(p => {
                                            p.hover.attr("d", path);
                                            p.visible.attr("d", path);
                                        });
                                        updateCityPositions();
                                        
                                        momentumAnimation = requestAnimationFrame(animate);
                                    }
                                    
                                    momentumAnimation = requestAnimationFrame(animate);
                                }
                                
                                function updatePaths() {
                                    if (isDragging || needsUpdate) {
                                        countries.attr("d", path);
                                        latitudePaths.forEach(p => {
                                            p.hover.attr("d", path);
                                            p.visible.attr("d", path);
                                        });
                                        updateCityPositions();
                                        needsUpdate = false;
                                    }
                                }
                                
                                svg.on("click", function() {
                                    if (momentumAnimation) {
                                        cancelAnimationFrame(momentumAnimation);
                                        momentumAnimation = null;
                                        velocity = [0, 0];
                                    }
                                });
                                
                                const drag = d3.drag()
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended);
                                
                                svg.call(drag);
                                
                                // Zoom controls
                                let currentScale = 1;
                                
                                function updateZoom(newScale) {
                                    currentScale = Math.max(0.5, Math.min(5, newScale));
                                    const scale = radius * currentScale;
                                    projection.scale(scale);
                                    globe.attr("r", scale);
                                    countries.attr("d", path);
                                    latitudePaths.forEach(p => {
                                        p.hover.attr("d", path);
                                        p.visible.attr("d", path);
                                    });
                                    updateCityPositions();
                                }
                                
                                document.getElementById('zoom-in').addEventListener('click', function() {
                                    updateZoom(currentScale * 1.3);
                                });
                                
                                document.getElementById('zoom-out').addEventListener('click', function() {
                                    updateZoom(currentScale / 1.3);
                                });
                                
                                // Legend toggle
                                const legendToggle = document.getElementById('legend-toggle');
                                const legendContent = document.getElementById('legend-content');
                                const legendToggleIcon = legendToggle.querySelector('.legend-toggle');
                                
                                legendToggle.addEventListener('click', function() {
                                    legendContent.classList.toggle('collapsed');
                                    legendToggleIcon.textContent = legendContent.classList.contains('collapsed') ? '+' : '‚àí';
                                });
                                
                                // City names toggle
                                const showCitiesCheckbox = document.getElementById('show-cities');
                                showCitiesCheckbox.addEventListener('change', function() {
                                    updateCityPositions();
                                });
                            })
                            .catch(error => console.error('Error loading GeoJSON:', error));
                    }
                });
            })
            .catch(error => console.error('Error reading CSV:', error));
        
        // Handle window resize
        window.addEventListener('resize', function() {
            location.reload();
        });
    </script>
</body>
</html>
